<!doctype html>
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.68.3" />

<META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">



<link rel="shortcut icon" href="/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/favicons/android-192x192.png" sizes="192x192">

<title>第三章 ConfigController源代码解析 | 郭栋的博客</title><meta property="og:title" content="第三章 ConfigController源代码解析" />
<meta property="og:description" content="一、对象模型 具体的对象模型 Istio中有一些新定义的对象模型，例如VirtualService、DestinationRule等等，它们在kubernetes中作为crd对象存在，它们在Istio中被统称为config，为了管理这些crd对象，Istio内部定义一些controller，被称为ConfigController，除了管理crd对象外，还有一些管理其它对象的ConfigController。具体而言，管理crd对象的ConfigController被称为crd ConfigController，或者简称为crd controller，代码位于pilot/pkg/config/kube/crd
Envoy除了作为sidecar之外，还可以作为ingress网关，用作整个集群的入口，这种情况下它的工作模式不同于sidecar模式，因此需要另外定义另一种ConfigController来对这种模式下的对象模型进行管理，它们被称为ingress ConfigController，代码位于pilot/pkg/config/kube/ingress
为了方便调试，又开发了基于内存的controller，被称为memory ConfigController，代码位于pilot/pkg/config/memory
上面提到的crd controller和ingress controller直接与kubernetes交互，为了解耦Istio与Kubernetes，又开发了一个新的抽象层，被称为mcp controller。代码位于pilot/pkg/serviceregistry/mcp，注意它与上面的几个controller都不在同一个目录下，这是因为mcp controller不仅实现了ConfigController的功能，同时也实现了ServiceController的功能，详见上一节的内容。
具体对象模型的抽象父接口 这些具体的ConfigController有2个共同的父接口，被称为model.ConfigStore和model.ConfigSotreCache，其中ConfigStore可以认为是一个静态的接口，可以通过这个接口中的函数来对config对象进行增删改查，其中有一个Schemas字段，包含了所有的原始对象。ConfigStore的定义如下
type ConfigStore interface { Schemas() collection.Schemas Get(typ resource.GroupVersionKind, name, namespace string) *Config List(typ resource.GroupVersionKind, namespace string) ([]Config, error) Create(config Config) (revision string, err error) Update(config Config) (newRevision string, err error) Delete(typ resource.GroupVersionKind, name, namespace string) error ... } 而另一个对象ConfigSotreCache相对于ConfigStore而言，是一个动态的接口，定义如下
type ConfigStoreCache interface { ConfigStore RegisterEventHandler(kind resource.GroupVersionKind, handler func(Config, Config, Event)) Run(stop &lt;-chan struct{}) HasSynced() bool } 首先，它继承了ConfigStore，另外它定义了Run()表明它是可以作为一个动态对象来Run，它还定义了一个RegisterEventHandler()函数，用来添加一些回调函数，当config发生改变的时候会触发这些回调函数。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/docs/istio/code/discovery/configcontroller/" />
<meta property="article:published_time" content="2017-01-04T00:00:00+00:00" />
<meta property="article:modified_time" content="2020-07-13T13:29:51+08:00" />
<meta itemprop="name" content="第三章 ConfigController源代码解析">
<meta itemprop="description" content="一、对象模型 具体的对象模型 Istio中有一些新定义的对象模型，例如VirtualService、DestinationRule等等，它们在kubernetes中作为crd对象存在，它们在Istio中被统称为config，为了管理这些crd对象，Istio内部定义一些controller，被称为ConfigController，除了管理crd对象外，还有一些管理其它对象的ConfigController。具体而言，管理crd对象的ConfigController被称为crd ConfigController，或者简称为crd controller，代码位于pilot/pkg/config/kube/crd
Envoy除了作为sidecar之外，还可以作为ingress网关，用作整个集群的入口，这种情况下它的工作模式不同于sidecar模式，因此需要另外定义另一种ConfigController来对这种模式下的对象模型进行管理，它们被称为ingress ConfigController，代码位于pilot/pkg/config/kube/ingress
为了方便调试，又开发了基于内存的controller，被称为memory ConfigController，代码位于pilot/pkg/config/memory
上面提到的crd controller和ingress controller直接与kubernetes交互，为了解耦Istio与Kubernetes，又开发了一个新的抽象层，被称为mcp controller。代码位于pilot/pkg/serviceregistry/mcp，注意它与上面的几个controller都不在同一个目录下，这是因为mcp controller不仅实现了ConfigController的功能，同时也实现了ServiceController的功能，详见上一节的内容。
具体对象模型的抽象父接口 这些具体的ConfigController有2个共同的父接口，被称为model.ConfigStore和model.ConfigSotreCache，其中ConfigStore可以认为是一个静态的接口，可以通过这个接口中的函数来对config对象进行增删改查，其中有一个Schemas字段，包含了所有的原始对象。ConfigStore的定义如下
type ConfigStore interface { Schemas() collection.Schemas Get(typ resource.GroupVersionKind, name, namespace string) *Config List(typ resource.GroupVersionKind, namespace string) ([]Config, error) Create(config Config) (revision string, err error) Update(config Config) (newRevision string, err error) Delete(typ resource.GroupVersionKind, name, namespace string) error ... } 而另一个对象ConfigSotreCache相对于ConfigStore而言，是一个动态的接口，定义如下
type ConfigStoreCache interface { ConfigStore RegisterEventHandler(kind resource.GroupVersionKind, handler func(Config, Config, Event)) Run(stop &lt;-chan struct{}) HasSynced() bool } 首先，它继承了ConfigStore，另外它定义了Run()表明它是可以作为一个动态对象来Run，它还定义了一个RegisterEventHandler()函数，用来添加一些回调函数，当config发生改变的时候会触发这些回调函数。">
<meta itemprop="datePublished" content="2017-01-04T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2020-07-13T13:29:51&#43;08:00" />
<meta itemprop="wordCount" content="674">



<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="第三章 ConfigController源代码解析"/>
<meta name="twitter:description" content="一、对象模型 具体的对象模型 Istio中有一些新定义的对象模型，例如VirtualService、DestinationRule等等，它们在kubernetes中作为crd对象存在，它们在Istio中被统称为config，为了管理这些crd对象，Istio内部定义一些controller，被称为ConfigController，除了管理crd对象外，还有一些管理其它对象的ConfigController。具体而言，管理crd对象的ConfigController被称为crd ConfigController，或者简称为crd controller，代码位于pilot/pkg/config/kube/crd
Envoy除了作为sidecar之外，还可以作为ingress网关，用作整个集群的入口，这种情况下它的工作模式不同于sidecar模式，因此需要另外定义另一种ConfigController来对这种模式下的对象模型进行管理，它们被称为ingress ConfigController，代码位于pilot/pkg/config/kube/ingress
为了方便调试，又开发了基于内存的controller，被称为memory ConfigController，代码位于pilot/pkg/config/memory
上面提到的crd controller和ingress controller直接与kubernetes交互，为了解耦Istio与Kubernetes，又开发了一个新的抽象层，被称为mcp controller。代码位于pilot/pkg/serviceregistry/mcp，注意它与上面的几个controller都不在同一个目录下，这是因为mcp controller不仅实现了ConfigController的功能，同时也实现了ServiceController的功能，详见上一节的内容。
具体对象模型的抽象父接口 这些具体的ConfigController有2个共同的父接口，被称为model.ConfigStore和model.ConfigSotreCache，其中ConfigStore可以认为是一个静态的接口，可以通过这个接口中的函数来对config对象进行增删改查，其中有一个Schemas字段，包含了所有的原始对象。ConfigStore的定义如下
type ConfigStore interface { Schemas() collection.Schemas Get(typ resource.GroupVersionKind, name, namespace string) *Config List(typ resource.GroupVersionKind, namespace string) ([]Config, error) Create(config Config) (revision string, err error) Update(config Config) (newRevision string, err error) Delete(typ resource.GroupVersionKind, name, namespace string) error ... } 而另一个对象ConfigSotreCache相对于ConfigStore而言，是一个动态的接口，定义如下
type ConfigStoreCache interface { ConfigStore RegisterEventHandler(kind resource.GroupVersionKind, handler func(Config, Config, Event)) Run(stop &lt;-chan struct{}) HasSynced() bool } 首先，它继承了ConfigStore，另外它定义了Run()表明它是可以作为一个动态对象来Run，它还定义了一个RegisterEventHandler()函数，用来添加一些回调函数，当config发生改变的时候会触发这些回调函数。"/>





<link rel="preload" href="/scss/main.min.2ee4f97cec4f212321e49585048d1214cfa48bdaf90874c970e6498839185f85.css" as="style">
<link href="/scss/main.min.2ee4f97cec4f212321e49585048d1214cfa48bdaf90874c970e6498839185f85.css" rel="stylesheet" integrity="">


<script
  src="https://code.jquery.com/jquery-3.3.1.min.js"
  integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
  crossorigin="anonymous"></script>


  </head>
  <body class="td-page">
    <header>
      
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
        <a class="navbar-brand" href="/">
		<span class="navbar-logo"></span><span class="text-uppercase font-weight-bold">郭栋的博客</span>
	</a>
	<div class="td-navbar-nav-scroll ml-md-auto" id="main_navbar">
		<ul class="navbar-nav mt-2 mt-lg-0">
			
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				<a class="nav-link" href="/about/" ><span>About</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				<a class="nav-link active" href="/docs/" ><span class="active">Documentation</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				<a class="nav-link" href="https://github.com/mcsos/website" target="_blank" ><span>GitHub</span></a>
			</li>
			
			
			
		</ul>
	</div>
	<div class="navbar-nav d-none d-lg-block">
</div>
</nav>

    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
            




<div id="td-sidebar-menu" class="td-sidebar__inner">
  
  <form class="td-sidebar__search d-flex align-items-center">
    

    <button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type="button" data-toggle="collapse" data-target="#td-section-nav" aria-controls="td-docs-nav" aria-expanded="false" aria-label="Toggle section navigation">
    </button>
  </form>
  
  <nav class="collapse td-sidebar-nav pt-2 pl-4" id="td-section-nav">
    
    






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/" class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section">Documentation</a>
  </li>
  <ul>
    <li class="collapse show" id="docs">
      
      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/istio/" class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section">Istio学习笔记</a>
  </li>
  <ul>
    <li class="collapse show" id="docsistio">
      
      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/istio/understanding/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">深入理解Istio</a>
  </li>
  <ul>
    <li class="collapse " id="docsistiounderstanding">
      
      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/istio/understanding/traffic/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">流量管理</a>
  </li>
  <ul>
    <li class="collapse " id="docsistiounderstandingtraffic">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/istio/understanding/security/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">安全机制</a>
  </li>
  <ul>
    <li class="collapse " id="docsistiounderstandingsecurity">
      
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docsistiounderstandingsecuritymtls" href="/docs/istio/understanding/security/mtls/">双向tls认证</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docsistiounderstandingsecurityenduser_authentication" href="/docs/istio/understanding/security/enduser_authentication/">对终端用户的认证</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docsistiounderstandingsecurityauthorization" href="/docs/istio/understanding/security/authorization/">授权</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docsistiounderstandingsecurity_enduser_authentication" href="/docs/istio/understanding/security/_enduser_authentication/"></a>
      
      
    </li>
  </ul>
</ul>

      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/istio/code/" class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section">Istio源代码解析</a>
  </li>
  <ul>
    <li class="collapse show" id="docsistiocode">
      
      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/istio/code/discovery/" class="align-left pl-0 pr-2 active td-sidebar-link td-sidebar-link__section">Pilot Discovery</a>
  </li>
  <ul>
    <li class="collapse show" id="docsistiocodediscovery">
      
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docsistiocodediscoveryintro" href="/docs/istio/code/discovery/intro/">第一章 概述</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docsistiocodediscoveryservicecontroller" href="/docs/istio/code/discovery/servicecontroller/">第二章 ServiceController</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page  active" id="m-docsistiocodediscoveryconfigcontroller" href="/docs/istio/code/discovery/configcontroller/">第三章 ConfigController</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docsistiocodediscoverydiscoveryserver" href="/docs/istio/code/discovery/discoveryserver/">第四章 DiscoveryServer</a>
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/istio/code/agent/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Pilot Agent</a>
  </li>
  <ul>
    <li class="collapse " id="docsistiocodeagent">
      
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docsistiocodeagentagent" href="/docs/istio/code/agent/agent/">第一章 Agent主要组件</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docsistiocodeagentproxy" href="/docs/istio/code/agent/proxy/">第二章 Envoy启动过程</a>
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/istio/code/certificate/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">证书管理</a>
  </li>
  <ul>
    <li class="collapse " id="docsistiocodecertificate">
      
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docsistiocodecertificateintro" href="/docs/istio/code/certificate/intro/">第一章 概述</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docsistiocodecertificateistiod_cert" href="/docs/istio/code/certificate/istiod_cert/">第二章 Istiod服务器端证书</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docsistiocodecertificatecaserver" href="/docs/istio/code/certificate/caserver/">第三章 CA Server</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docsistiocodecertificatesdsserver" href="/docs/istio/code/certificate/sdsserver/">第四章 SDS Server</a>
      
      
    </li>
  </ul>
</ul>

      
      
    </li>
  </ul>
</ul>

      
      
    </li>
  </ul>
</ul>

      
      
    </li>
  </ul>
</ul>

  </nav>
</div>




          </div>
          <div class="d-none d-xl-block col-xl-2 td-toc d-print-none">
            











<nav id="TableOfContents">
  <ul>
    <li><a href="#一对象模型-">一、对象模型</a>
      <ul>
        <li><a href="#具体的对象模型-">具体的对象模型</a></li>
        <li><a href="#具体对象模型的抽象父接口-">具体对象模型的抽象父接口</a></li>
        <li><a href="#聚合对象-">聚合对象</a></li>
      </ul>
    </li>
    <li><a href="#二启动过程分析-">二、启动过程分析</a>
      <ul>
        <li><a href="#模型定义-">模型定义</a></li>
        <li><a href="#初始化-">初始化</a></li>
        <li><a href="#注册回调函数-">注册回调函数</a></li>
      </ul>
    </li>
  </ul>
</nav>



          </div>
          <main class="col-12 col-md-9 col-xl-8 pl-md-5" role="main">
            
  

            <nav aria-label="breadcrumb" class="d-none d-md-block d-print-none">
	<ol class="breadcrumb spb-1">
		
















<li class="breadcrumb-item" >
	<a href="/docs/">Documentation</a>
</li>




<li class="breadcrumb-item" >
	<a href="/docs/istio/">Istio学习笔记</a>
</li>




<li class="breadcrumb-item" >
	<a href="/docs/istio/code/">Istio源代码解析</a>
</li>




<li class="breadcrumb-item" >
	<a href="/docs/istio/code/discovery/">Pilot Discovery</a>
</li>




<li class="breadcrumb-item active" aria-current="page">
	<a href="/docs/istio/code/discovery/configcontroller/">第三章 ConfigController</a>
</li>

	</ol>
</nav	>

            
<div class="td-content">
	<h1>第三章 ConfigController源代码解析</h1>
    
	       
	<figure><a href="../configcontroller_data_1.png" target="_blank">
    <img src="../configcontroller_data_1.png"/> </a>
</figure>

<h2 id="一对象模型-">一、对象模型</h2>
<h3 id="具体的对象模型-">具体的对象模型</h3>
<p>Istio中有一些新定义的对象模型，例如VirtualService、DestinationRule等等，它们在kubernetes中作为crd对象存在，它们在Istio中被统称为config，为了管理这些crd对象，Istio内部定义一些controller，被称为ConfigController，除了管理crd对象外，还有一些管理其它对象的ConfigController。具体而言，管理crd对象的ConfigController被称为crd ConfigController，或者简称为crd controller，代码位于<code>pilot/pkg/config/kube/crd</code></p>
<p>Envoy除了作为sidecar之外，还可以作为ingress网关，用作整个集群的入口，这种情况下它的工作模式不同于sidecar模式，因此需要另外定义另一种ConfigController来对这种模式下的对象模型进行管理，它们被称为ingress ConfigController，代码位于<code>pilot/pkg/config/kube/ingress</code></p>
<p>为了方便调试，又开发了基于内存的controller，被称为memory ConfigController，代码位于<code>pilot/pkg/config/memory</code></p>
<p>上面提到的crd controller和ingress controller直接与kubernetes交互，为了解耦Istio与Kubernetes，又开发了一个新的抽象层，被称为mcp controller。代码位于<code>pilot/pkg/serviceregistry/mcp</code>，注意它与上面的几个controller都不在同一个目录下，这是因为mcp controller不仅实现了ConfigController的功能，同时也实现了ServiceController的功能，详见上一节的内容。</p>
<h3 id="具体对象模型的抽象父接口-">具体对象模型的抽象父接口</h3>
<p>这些具体的ConfigController有2个共同的父接口，被称为model.ConfigStore和model.ConfigSotreCache，其中ConfigStore可以认为是一个静态的接口，可以通过这个接口中的函数来对config对象进行增删改查，其中有一个<code>Schemas</code>字段，包含了所有的原始对象。ConfigStore的定义如下</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">ConfigStore</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000;font-weight:bold">{</span>
	<span style="color:#000">Schemas</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">collection</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Schemas</span>

	<span style="color:#000">Get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">typ</span> <span style="color:#000">resource</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GroupVersionKind</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">namespace</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Config</span>
	<span style="color:#000">List</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">typ</span> <span style="color:#000">resource</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GroupVersionKind</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">namespace</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">([]</span><span style="color:#000">Config</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
	<span style="color:#000">Create</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">config</span> <span style="color:#000">Config</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">revision</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
	<span style="color:#000">Update</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">config</span> <span style="color:#000">Config</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">newRevision</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
	<span style="color:#000">Delete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">typ</span> <span style="color:#000">resource</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GroupVersionKind</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">namespace</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span>
    <span style="color:#ce5c00;font-weight:bold">...</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>而另一个对象ConfigSotreCache相对于ConfigStore而言，是一个动态的接口，定义如下</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">ConfigStoreCache</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000;font-weight:bold">{</span>
	<span style="color:#000">ConfigStore</span>

	<span style="color:#000">RegisterEventHandler</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kind</span> <span style="color:#000">resource</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GroupVersionKind</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">handler</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Config</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Config</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Event</span><span style="color:#000;font-weight:bold">))</span>
	<span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stop</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{})</span>
	<span style="color:#000">HasSynced</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">bool</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>首先，它继承了ConfigStore，另外它定义了<code>Run()</code>表明它是可以作为一个动态对象来Run，它还定义了一个<code>RegisterEventHandler()</code>函数，用来添加一些回调函数，当config发生改变的时候会触发这些回调函数。</p>
<p>除了这两个Interface之外，还有一个名为IstioConfigStore的Interface，它主要用于获取外部服务的相关信息，我们不会对其进行详细分析，定义如下</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">IstioConfigStore</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000;font-weight:bold">{</span>
	<span style="color:#000">ConfigStore</span>
	<span style="color:#000">ServiceEntries</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#000">Config</span>
	<span style="color:#000">Gateways</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">workloadLabels</span> <span style="color:#000">labels</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Collection</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#000">Config</span>
    <span style="color:#ce5c00;font-weight:bold">...</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><h3 id="聚合对象-">聚合对象</h3>
<p>现在回到上文提到的具体的ConfigController的实现，包括ingress controller、crd controller、mcp controller等，为了对它们进行统一管理，创建了两个新的聚合controller。代码都位于<code>pilot/pkg/config/aggregate</code></p>
<p>其中第一个聚合对象叫store</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">store</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
	<span style="color:#000">schemas</span> <span style="color:#000">collection</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Schemas</span>
	<span style="color:#000">stores</span> <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">resource</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GroupVersionKind</span><span style="color:#000;font-weight:bold">][]</span><span style="color:#000">model</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ConfigStore</span>
    <span style="color:#ce5c00;font-weight:bold">...</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>一方面它内部包含有schemas字段，用来存储原始对象，还包含一个stores字段，这是一个map，用来分类存储各种ConfigStore对象。另一方面它继承了上文提到的model.ConfigStore接口，也就意味着当对这个store执行model.ConfigStore接口里的函数时，store会遍历自己内部存储的各种具体的ConfigController对象，分别对他们对应的操作，来看一个例子</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#8f5902;font-style:italic">// List all configs in the stores.
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">cr</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">store</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">List</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">typ</span> <span style="color:#000">resource</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GroupVersionKind</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">namespace</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">([]</span><span style="color:#000">model</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Config</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#ce5c00;font-weight:bold">...</span>
	<span style="color:#000">configMap</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">]</span><span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{})</span>

	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">store</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">cr</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">stores</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">typ</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">{</span>
		<span style="color:#000">storeConfigs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">store</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">List</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">typ</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">namespace</span><span style="color:#000;font-weight:bold">)</span>
        <span style="color:#ce5c00;font-weight:bold">...</span>
		<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">config</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">storeConfigs</span> <span style="color:#000;font-weight:bold">{</span>
			<span style="color:#000">key</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Type</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Namespace</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span>
			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">exist</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">configMap</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">];</span> <span style="color:#000">exist</span> <span style="color:#000;font-weight:bold">{</span>
				<span style="color:#204a87;font-weight:bold">continue</span>
			<span style="color:#000;font-weight:bold">}</span>
			<span style="color:#000">configs</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">configs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">)</span>
			<span style="color:#000">configMap</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{}{}</span>
		<span style="color:#000;font-weight:bold">}</span>
	<span style="color:#000;font-weight:bold">}</span>
	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">configs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">errs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ErrorOrNil</span><span style="color:#000;font-weight:bold">()</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>这是store继承并实现的model.ConfigStore接口中的List()函数，可以看出它就是遍历内部的各种ConfigController对象，然后在内部将各种config对象聚合到一起然后返回。</p>
<p>第二个聚合对象叫storeCache</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">storeCache</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
	<span style="color:#000">model</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ConfigStore</span>
	<span style="color:#000">caches</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#000">model</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ConfigStoreCache</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>它有一个caches数组，里面包含了具体的各种ConfigController对象(因为它们都实现了ConfigStoreCache Interface)。另一方面storeCache实现了model.ConfigStoreCache Interface。当执行对这个storeCache对象执行model.ConfigStoreCache接口里的函数时，storeCache会遍历自己内部存储的各种具体的ConfigController对象，分别对他们对应的操作，下面是<code>RegisterEventHandler()</code>的实现</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">cr</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">storeCache</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">RegisterEventHandler</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kind</span> <span style="color:#000">resource</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GroupVersionKind</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">handler</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">model</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Config</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">model</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Config</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">model</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Event</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cache</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">cr</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">caches</span> <span style="color:#000;font-weight:bold">{</span>
		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">exists</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Schemas</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">FindByGroupVersionKind</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kind</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">exists</span> <span style="color:#000;font-weight:bold">{</span>
			<span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterEventHandler</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kind</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">handler</span><span style="color:#000;font-weight:bold">)</span>
		<span style="color:#000;font-weight:bold">}</span>
	<span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>可以看到这个函数的逻辑就是遍历内部的cache数组，然后针对每个具体的ConfigController对象执行<code>RegisterEventHandler()</code>调用。</p>
<h2 id="二启动过程分析-">二、启动过程分析</h2>
<h3 id="模型定义-">模型定义</h3>
<p>Istio pilot discovery有一个总的Server对象</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Server</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#ce5c00;font-weight:bold">...</span>
	<span style="color:#000">environment</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">model</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Environment</span>

	<span style="color:#000">configController</span>  <span style="color:#000">model</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ConfigStoreCache</span>

	<span style="color:#000">ConfigStores</span>      <span style="color:#000;font-weight:bold">[]</span><span style="color:#000">model</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ConfigStoreCache</span>
    <span style="color:#ce5c00;font-weight:bold">...</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>和ConfigController相关的有三个成员。其中Server.ConfigStores就是各种ConfigController实例组成一个数组，而Server.configController就是config.aggregate.storeCache的实例，内部包含了Server.ConfigStores对象。</p>
<p>另外一个是environment成员</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Environment</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
	<span style="color:#000">IstioConfigStore</span>
    <span style="color:#ce5c00;font-weight:bold">...</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>它里面的IstioConfigStore成员就是上文中提到的model.IstioConfigStore，主要用于获取外部服务等信息。</p>
<h3 id="初始化-">初始化</h3>
<p>main函数位于<code>pilot/cmd/pilot-discovery/main.go</code>中</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000;font-weight:bold">(</span>
    <span style="color:#ce5c00;font-weight:bold">...</span>
	<span style="color:#000">discoveryCmd</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">cobra</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Command</span><span style="color:#000;font-weight:bold">{</span>
		<span style="color:#000">Use</span><span style="color:#000;font-weight:bold">:</span>   <span style="color:#4e9a06">&#34;discovery&#34;</span><span style="color:#000;font-weight:bold">,</span>
		<span style="color:#000">Short</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Start Istio proxy discovery service.&#34;</span><span style="color:#000;font-weight:bold">,</span>
		<span style="color:#000">Args</span><span style="color:#000;font-weight:bold">:</span>  <span style="color:#000">cobra</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ExactArgs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">),</span>
		<span style="color:#000">RunE</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">cobra</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Command</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
			<span style="color:#000">discoveryServer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">bootstrap</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewServer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">serverArgs</span><span style="color:#000;font-weight:bold">)</span>
            <span style="color:#ce5c00;font-weight:bold">...</span>
			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">discoveryServer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Start</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stop</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
				<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;failed to start discovery service: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
			<span style="color:#000;font-weight:bold">}</span>
            <span style="color:#ce5c00;font-weight:bold">...</span>
		<span style="color:#000;font-weight:bold">},</span>
	<span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">)</span>


<span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">init</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#ce5c00;font-weight:bold">...</span>
	<span style="color:#000">rootCmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddCommand</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">discoveryCmd</span><span style="color:#000;font-weight:bold">)</span>
    <span style="color:#ce5c00;font-weight:bold">...</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">rootCmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Execute</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
		<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errora</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
		<span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
	<span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>

</code></pre></div><p>初始化代码位于<code>bootstrap.NewServer(serverArgs)</code>中</p>
<p>创建了Server对象后，会进行初始化，在<code>initControllers()</code>中</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">NewServer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">PilotArgs</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Server</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#ce5c00;font-weight:bold">...</span>
	<span style="color:#000">s</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">Server</span><span style="color:#000;font-weight:bold">{</span>
        <span style="color:#ce5c00;font-weight:bold">...</span>
		<span style="color:#000">environment</span><span style="color:#000;font-weight:bold">:</span>     <span style="color:#000">e</span><span style="color:#000;font-weight:bold">,</span>
        <span style="color:#ce5c00;font-weight:bold">...</span>
	<span style="color:#000;font-weight:bold">}</span>

    <span style="color:#ce5c00;font-weight:bold">...</span>
	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">initControllers</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
	<span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Server</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">initControllers</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">PilotArgs</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#ce5c00;font-weight:bold">...</span>
	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">initConfigController</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;error initializing config controller: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
	<span style="color:#000;font-weight:bold">}</span>
	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>下面详细分析<code>initConfigController()</code></p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Server</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">initConfigController</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">PilotArgs</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
	<span style="color:#000">meshConfig</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">environment</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Mesh</span><span style="color:#000;font-weight:bold">()</span>
	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">meshConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ConfigSources</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">initMCPConfigController</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
			<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
		<span style="color:#000;font-weight:bold">}</span>
	<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FileDir</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#4e9a06">&#34;&#34;</span> <span style="color:#000;font-weight:bold">{</span>
		<span style="color:#000">store</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">memory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">collections</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pilot</span><span style="color:#000;font-weight:bold">)</span>
		<span style="color:#000">configController</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">memory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewController</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">store</span><span style="color:#000;font-weight:bold">)</span>
		<span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ConfigStores</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ConfigStores</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">configController</span><span style="color:#000;font-weight:bold">)</span>
	<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
		<span style="color:#000">configController</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">makeKubeConfigController</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span><span style="color:#000;font-weight:bold">)</span>
        <span style="color:#ce5c00;font-weight:bold">...</span>
		<span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ConfigStores</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ConfigStores</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">configController</span><span style="color:#000;font-weight:bold">)</span>
        <span style="color:#ce5c00;font-weight:bold">...</span>
	<span style="color:#000;font-weight:bold">}</span>
    <span style="color:#ce5c00;font-weight:bold">...</span>
</code></pre></div><p>这个函数首先用根据配置来创建不同的ConfigController：MCP Controller(如果符合这个条件，则创建后会立即返回)、Memery Controller和Kubernetes Controller。然后controller加到Server.ConfigStores中</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang">	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">hasKubeRegistry</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Service</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Registries</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">meshConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">IngressControllerMode</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">meshconfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MeshConfig_OFF</span> <span style="color:#000;font-weight:bold">{</span>
		<span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ConfigStores</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ConfigStores</span><span style="color:#000;font-weight:bold">,</span>
			<span style="color:#000">ingress</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewController</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">kubeClient</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">meshConfig</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ControllerOptions</span><span style="color:#000;font-weight:bold">))</span>
        <span style="color:#ce5c00;font-weight:bold">...</span>
	<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>接下来如果启用了ingress模式，则会将Ingress Controller也加入Server.ConfigStores中。</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang">	<span style="color:#000">aggregateConfigController</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">configaggregate</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MakeCache</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ConfigStores</span><span style="color:#000;font-weight:bold">)</span>
	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
	<span style="color:#000;font-weight:bold">}</span>
	<span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">configController</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">aggregateConfigController</span>

	<span style="color:#8f5902;font-style:italic">// Create the config store.
</span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">environment</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">IstioConfigStore</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">model</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MakeIstioStore</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">configController</span><span style="color:#000;font-weight:bold">)</span>

	<span style="color:#8f5902;font-style:italic">// Defer starting the controller until after the service is created.
</span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">addStartFunc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stop</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
		<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">configController</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stop</span><span style="color:#000;font-weight:bold">)</span>
		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
	<span style="color:#000;font-weight:bold">})</span>

	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>最后会根据Server.ConfigStores生成Server.configController，这个在上面分析过，就是config.aggregate.storeCache的实例。</p>
<p>最后会添加启动的回调函数，当Server启动时也会启动Server.configController。</p>
<h3 id="注册回调函数-">注册回调函数</h3>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">NewServer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">PilotArgs</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Server</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
	<span style="color:#000">e</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">model</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Environment</span><span style="color:#000;font-weight:bold">{</span>
		<span style="color:#000">ServiceDiscovery</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">aggregate</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewController</span><span style="color:#000;font-weight:bold">(),</span>
		<span style="color:#000">PushContext</span><span style="color:#000;font-weight:bold">:</span>      <span style="color:#000">model</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewPushContext</span><span style="color:#000;font-weight:bold">(),</span>
		<span style="color:#000">DomainSuffix</span><span style="color:#000;font-weight:bold">:</span>     <span style="color:#000">args</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ControllerOptions</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DomainSuffix</span><span style="color:#000;font-weight:bold">,</span>
	<span style="color:#000;font-weight:bold">}</span>

	<span style="color:#000">s</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">Server</span><span style="color:#000;font-weight:bold">{</span>
		<span style="color:#000">clusterID</span><span style="color:#000;font-weight:bold">:</span>       <span style="color:#000">getClusterID</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span><span style="color:#000;font-weight:bold">),</span>
		<span style="color:#000">environment</span><span style="color:#000;font-weight:bold">:</span>     <span style="color:#000">e</span><span style="color:#000;font-weight:bold">,</span>
        <span style="color:#ce5c00;font-weight:bold">...</span>
	<span style="color:#000;font-weight:bold">}</span>

    <span style="color:#ce5c00;font-weight:bold">...</span>

	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">initControllers</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
	<span style="color:#000;font-weight:bold">}</span>

    <span style="color:#ce5c00;font-weight:bold">...</span>
	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">initRegistryEventHandlers</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;error initializing handlers: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
	<span style="color:#000;font-weight:bold">}</span>
    <span style="color:#ce5c00;font-weight:bold">...</span>

	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>注册回调函数的代码在<code>initRegistryEventHandlers()</code></p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#8f5902;font-style:italic">// initRegistryEventHandlers sets up event handlers for config and service updates
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Server</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">initRegistryEventHandlers</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#ce5c00;font-weight:bold">...</span>

	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">configController</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
		<span style="color:#000">configHandler</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">curr</span> <span style="color:#000">model</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Config</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">event</span> <span style="color:#000">model</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Event</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
			<span style="color:#000">pushReq</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">model</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PushRequest</span><span style="color:#000;font-weight:bold">{</span>
				<span style="color:#000">Full</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span>
				<span style="color:#000">ConfigsUpdated</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">model</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ConfigKey</span><span style="color:#000;font-weight:bold">]</span><span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{}{{</span>
					<span style="color:#000">Kind</span><span style="color:#000;font-weight:bold">:</span>      <span style="color:#000">curr</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GroupVersionKind</span><span style="color:#000;font-weight:bold">(),</span>
					<span style="color:#000">Name</span><span style="color:#000;font-weight:bold">:</span>      <span style="color:#000">curr</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span>
					<span style="color:#000">Namespace</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">curr</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Namespace</span><span style="color:#000;font-weight:bold">,</span>
				<span style="color:#000;font-weight:bold">}:</span> <span style="color:#000;font-weight:bold">{}},</span>
				<span style="color:#000">Reason</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#000">model</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">TriggerReason</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">model</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ConfigUpdate</span><span style="color:#000;font-weight:bold">},</span>
			<span style="color:#000;font-weight:bold">}</span>
			<span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EnvoyXdsServer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ConfigUpdate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pushReq</span><span style="color:#000;font-weight:bold">)</span>
            <span style="color:#ce5c00;font-weight:bold">...</span>
		<span style="color:#000;font-weight:bold">}</span>
		<span style="color:#000">schemas</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">collections</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pilot</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">All</span><span style="color:#000;font-weight:bold">()</span>
        <span style="color:#ce5c00;font-weight:bold">...</span>
		<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">schema</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">schemas</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#ce5c00;font-weight:bold">...</span>
			<span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">configController</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterEventHandler</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">schema</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Resource</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">GroupVersionKind</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">configHandler</span><span style="color:#000;font-weight:bold">)</span>
		<span style="color:#000;font-weight:bold">}</span>
	<span style="color:#000;font-weight:bold">}</span>

	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>这里使用<code>config.aggregate.storeCache.RegisterEventHandler()</code>注册了处理Config的回调函数。</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">cr</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">storeCache</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">RegisterEventHandler</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kind</span> <span style="color:#000">resource</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GroupVersionKind</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">handler</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">model</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Config</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">model</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Config</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">model</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Event</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cache</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">cr</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">caches</span> <span style="color:#000;font-weight:bold">{</span>
		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">exists</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Schemas</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">FindByGroupVersionKind</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kind</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">exists</span> <span style="color:#000;font-weight:bold">{</span>
			<span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterEventHandler</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kind</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">handler</span><span style="color:#000;font-weight:bold">)</span>
		<span style="color:#000;font-weight:bold">}</span>
	<span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>这部分上面看过，就是会遍历自己内部存储的各种具体的ConfigController对象，分别调用它们的对应接口把回调函数注册到每个ConfigController实例中。</p>
<p>例如kubernetes crd config controller，将这些回调函数注册到自身实例中后，会在watch到相关资源改变的情况下，来调用这些预先注册的回调函数做实际的事情。</p>
<p>比如上面的这个回调函数就是构造一个push请求，然后将其作为参数来更新与envoy通信的discovery server，后者会更新配置并将配置推送给envoy，详细的内容请见后续的文章。</p>

	
	
	<div class="text-muted mt-5 pt-3 border-top">Last modified July 13, 2020: <a  href="/commit/5d94f2132dfbeeffae3f605566cec0fd70ed9b4e">update (5d94f21)</a>
</div>
</div>


          </main>
        </div>
      </div>
      
<footer class="bg-dark py-5 row d-print-none">
  <div class="container-fluid mx-sm-5">
    <div class="row">
      <div class="col-6 col-sm-4 text-xs-center order-sm-2">
        
      </div>
      <div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
        
      </div>
      <div class="col-12 col-sm-4 text-center py-2 order-sm-2">
        <small class="text-white">&copy; 2020 微信: mcsos2048 All Rights Reserved</small>
        
	
      </div>
    </div>
  </div>
</footer>


    </div>
    
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>







<script src="/js/main.min.29b0315468c00226fa6f4556a9cebc0ac4fe1ce1457a01b22c0a06b329877383.js" integrity="sha256-KbAxVGjAAib6b0VWqc68CsT&#43;HOFFegGyLAoGsymHc4M=" crossorigin="anonymous"></script>



  </body>
</html>