<!doctype html>
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.68.3" />

<META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">



<link rel="shortcut icon" href="/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/favicons/android-192x192.png" sizes="192x192">

<title>第二章 CA Server | 郭栋的博客</title><meta property="og:title" content="第二章 CA Server" />
<meta property="og:description" content="一、对象模型 在Istiod内部有一个名为CA Server服务的组件，用来提供证书签名的服务。Pilot Agent内部的SDS Server会向CA Server发起签名请求，CA Server会针对请求进行应答。
SDS Server和CA Server之间进行通信时的接口名为IstioCertificateServiceServer，它只包含了一个函数CreateCertificate()，一方面SDS Server会通过gRPC调用这个函数，另一方面在CA Server中有一个名为pkg.server.ca.Server的对象会实现IstioCertificateServiceServer这个Interface中的CreateCertificate()函数以便对请求进行应答。
除了实现IstioCertificateServiceServer这个Interface之外，pkg.server.ca.Server还实现了另外一个Interface，名为IstioCAServiceServer，其中的函数名为HandleCSR()，这个Interface和函数已经被标记为过时的，我们在后续的文章中将不会对其进行分析，不过为了保持代码完整性，仍然把它包含在对象模型的图中。
现在回头看pkg.server.ca.Server
type Server struct { ... Authenticators []authenticator ca CertificateAuthority ... } 其中有两个核心字段
  Authenticators
第一个是Authenticators，它是authenticator类型的数组，在与SDS Server进行交互时，CA Server通过这个字段来对客户端的身份进行验证。
authenticator是一个Interface类型，代码中包含了四种实现
     认证类型 说明     ClientCertAuthenticator 客户端证书认证   IDTokenAuthenticator 通过OpenID Connect (OIDC) 对客户端请求中的Bearer值进行认证，用于google公有云   KubeJWTAuthenticator 通过kubeclient向Kubernetes API Server发起验证请求，验证请求中的JWT Token   jwtAuthenticator 通过OpenID Connect (OIDC) 向Kubernetes API Server验证请求中的JWT Token，主要用于Istiod部署于Kubernetes集群之外的场景    authenticator定义如下" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/docs/istio/code/certificate/caserver/" />
<meta property="article:published_time" content="2017-01-04T00:00:00+00:00" />
<meta property="article:modified_time" content="2017-01-04T00:00:00+00:00" />
<meta itemprop="name" content="第二章 CA Server">
<meta itemprop="description" content="一、对象模型 在Istiod内部有一个名为CA Server服务的组件，用来提供证书签名的服务。Pilot Agent内部的SDS Server会向CA Server发起签名请求，CA Server会针对请求进行应答。
SDS Server和CA Server之间进行通信时的接口名为IstioCertificateServiceServer，它只包含了一个函数CreateCertificate()，一方面SDS Server会通过gRPC调用这个函数，另一方面在CA Server中有一个名为pkg.server.ca.Server的对象会实现IstioCertificateServiceServer这个Interface中的CreateCertificate()函数以便对请求进行应答。
除了实现IstioCertificateServiceServer这个Interface之外，pkg.server.ca.Server还实现了另外一个Interface，名为IstioCAServiceServer，其中的函数名为HandleCSR()，这个Interface和函数已经被标记为过时的，我们在后续的文章中将不会对其进行分析，不过为了保持代码完整性，仍然把它包含在对象模型的图中。
现在回头看pkg.server.ca.Server
type Server struct { ... Authenticators []authenticator ca CertificateAuthority ... } 其中有两个核心字段
  Authenticators
第一个是Authenticators，它是authenticator类型的数组，在与SDS Server进行交互时，CA Server通过这个字段来对客户端的身份进行验证。
authenticator是一个Interface类型，代码中包含了四种实现
     认证类型 说明     ClientCertAuthenticator 客户端证书认证   IDTokenAuthenticator 通过OpenID Connect (OIDC) 对客户端请求中的Bearer值进行认证，用于google公有云   KubeJWTAuthenticator 通过kubeclient向Kubernetes API Server发起验证请求，验证请求中的JWT Token   jwtAuthenticator 通过OpenID Connect (OIDC) 向Kubernetes API Server验证请求中的JWT Token，主要用于Istiod部署于Kubernetes集群之外的场景    authenticator定义如下">
<meta itemprop="datePublished" content="2017-01-04T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2017-01-04T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="209">



<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="第二章 CA Server"/>
<meta name="twitter:description" content="一、对象模型 在Istiod内部有一个名为CA Server服务的组件，用来提供证书签名的服务。Pilot Agent内部的SDS Server会向CA Server发起签名请求，CA Server会针对请求进行应答。
SDS Server和CA Server之间进行通信时的接口名为IstioCertificateServiceServer，它只包含了一个函数CreateCertificate()，一方面SDS Server会通过gRPC调用这个函数，另一方面在CA Server中有一个名为pkg.server.ca.Server的对象会实现IstioCertificateServiceServer这个Interface中的CreateCertificate()函数以便对请求进行应答。
除了实现IstioCertificateServiceServer这个Interface之外，pkg.server.ca.Server还实现了另外一个Interface，名为IstioCAServiceServer，其中的函数名为HandleCSR()，这个Interface和函数已经被标记为过时的，我们在后续的文章中将不会对其进行分析，不过为了保持代码完整性，仍然把它包含在对象模型的图中。
现在回头看pkg.server.ca.Server
type Server struct { ... Authenticators []authenticator ca CertificateAuthority ... } 其中有两个核心字段
  Authenticators
第一个是Authenticators，它是authenticator类型的数组，在与SDS Server进行交互时，CA Server通过这个字段来对客户端的身份进行验证。
authenticator是一个Interface类型，代码中包含了四种实现
     认证类型 说明     ClientCertAuthenticator 客户端证书认证   IDTokenAuthenticator 通过OpenID Connect (OIDC) 对客户端请求中的Bearer值进行认证，用于google公有云   KubeJWTAuthenticator 通过kubeclient向Kubernetes API Server发起验证请求，验证请求中的JWT Token   jwtAuthenticator 通过OpenID Connect (OIDC) 向Kubernetes API Server验证请求中的JWT Token，主要用于Istiod部署于Kubernetes集群之外的场景    authenticator定义如下"/>





<link rel="preload" href="/scss/main.min.2ee4f97cec4f212321e49585048d1214cfa48bdaf90874c970e6498839185f85.css" as="style">
<link href="/scss/main.min.2ee4f97cec4f212321e49585048d1214cfa48bdaf90874c970e6498839185f85.css" rel="stylesheet" integrity="">


<script
  src="https://code.jquery.com/jquery-3.3.1.min.js"
  integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
  crossorigin="anonymous"></script>


  </head>
  <body class="td-page">
    <header>
      
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
        <a class="navbar-brand" href="/">
		<span class="navbar-logo"></span><span class="text-uppercase font-weight-bold">郭栋的博客</span>
	</a>
	<div class="td-navbar-nav-scroll ml-md-auto" id="main_navbar">
		<ul class="navbar-nav mt-2 mt-lg-0">
			
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				<a class="nav-link" href="/about/" ><span>About</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				<a class="nav-link active" href="/docs/" ><span class="active">Documentation</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				<a class="nav-link" href="https://github.com/mcsos/website" target="_blank" ><span>GitHub</span></a>
			</li>
			
			
			
		</ul>
	</div>
	<div class="navbar-nav d-none d-lg-block">
</div>
</nav>

    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
            




<div id="td-sidebar-menu" class="td-sidebar__inner">
  
  <form class="td-sidebar__search d-flex align-items-center">
    

    <button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type="button" data-toggle="collapse" data-target="#td-section-nav" aria-controls="td-docs-nav" aria-expanded="false" aria-label="Toggle section navigation">
    </button>
  </form>
  
  <nav class="collapse td-sidebar-nav pt-2 pl-4" id="td-section-nav">
    
    






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/" class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section">Documentation</a>
  </li>
  <ul>
    <li class="collapse show" id="docs">
      
      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/istio/" class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section">Istio学习笔记</a>
  </li>
  <ul>
    <li class="collapse show" id="docsistio">
      
      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/istio/understanding/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">深入理解Istio</a>
  </li>
  <ul>
    <li class="collapse " id="docsistiounderstanding">
      
      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/istio/understanding/traffic/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">流量管理</a>
  </li>
  <ul>
    <li class="collapse " id="docsistiounderstandingtraffic">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/istio/understanding/security/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">安全机制</a>
  </li>
  <ul>
    <li class="collapse " id="docsistiounderstandingsecurity">
      
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docsistiounderstandingsecuritymtls" href="/docs/istio/understanding/security/mtls/">双向tls认证</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docsistiounderstandingsecurityenduser_authentication" href="/docs/istio/understanding/security/enduser_authentication/">对终端用户的认证</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docsistiounderstandingsecurityauthorization" href="/docs/istio/understanding/security/authorization/">授权</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docsistiounderstandingsecurity_enduser_authentication" href="/docs/istio/understanding/security/_enduser_authentication/"></a>
      
      
    </li>
  </ul>
</ul>

      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/istio/code/" class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section">Istio源代码解析</a>
  </li>
  <ul>
    <li class="collapse show" id="docsistiocode">
      
      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/istio/code/discovery/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Pilot Discovery</a>
  </li>
  <ul>
    <li class="collapse " id="docsistiocodediscovery">
      
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docsistiocodediscoveryintro" href="/docs/istio/code/discovery/intro/">第一章 概述</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docsistiocodediscoveryservicecontroller" href="/docs/istio/code/discovery/servicecontroller/">第二章 ServiceController</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docsistiocodediscoveryconfigcontroller" href="/docs/istio/code/discovery/configcontroller/">第三章 ConfigController</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docsistiocodediscoverydiscoveryserver" href="/docs/istio/code/discovery/discoveryserver/">第四章 DiscoveryServer</a>
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/istio/code/agent/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Pilot Agent</a>
  </li>
  <ul>
    <li class="collapse " id="docsistiocodeagent">
      
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docsistiocodeagentagent" href="/docs/istio/code/agent/agent/">第一章 Agent主要组件</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docsistiocodeagentproxy" href="/docs/istio/code/agent/proxy/">第二章 Envoy启动过程</a>
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/istio/code/certificate/" class="align-left pl-0 pr-2 active td-sidebar-link td-sidebar-link__section">证书管理</a>
  </li>
  <ul>
    <li class="collapse show" id="docsistiocodecertificate">
      
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docsistiocodecertificateintro" href="/docs/istio/code/certificate/intro/">第一章 概述</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page  active" id="m-docsistiocodecertificatecaserver" href="/docs/istio/code/certificate/caserver/">第二章 CA Server</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docsistiocodecertificatesdsserver" href="/docs/istio/code/certificate/sdsserver/">第三章 SDS Server</a>
      
      
    </li>
  </ul>
</ul>

      
      
    </li>
  </ul>
</ul>

      
      
    </li>
  </ul>
</ul>

      
      
    </li>
  </ul>
</ul>

  </nav>
</div>




          </div>
          <div class="d-none d-xl-block col-xl-2 td-toc d-print-none">
            













          </div>
          <main class="col-12 col-md-9 col-xl-8 pl-md-5" role="main">
            
  

            <nav aria-label="breadcrumb" class="d-none d-md-block d-print-none">
	<ol class="breadcrumb spb-1">
		
















<li class="breadcrumb-item" >
	<a href="/docs/">Documentation</a>
</li>




<li class="breadcrumb-item" >
	<a href="/docs/istio/">Istio学习笔记</a>
</li>




<li class="breadcrumb-item" >
	<a href="/docs/istio/code/">Istio源代码解析</a>
</li>




<li class="breadcrumb-item" >
	<a href="/docs/istio/code/certificate/">证书管理</a>
</li>




<li class="breadcrumb-item active" aria-current="page">
	<a href="/docs/istio/code/certificate/caserver/">第二章 CA Server</a>
</li>

	</ol>
</nav	>

            
<div class="td-content">
	<h1>第二章 CA Server</h1>
    
	       
	<figure><a href="../caserver_data_1.png" target="_blank">
    <img src="../caserver_data_1.png"/> </a>
</figure>

<h2 id="一对象模型-">一、对象模型</h2>
<p>在Istiod内部有一个名为CA Server服务的组件，用来提供证书签名的服务。Pilot Agent内部的SDS Server会向CA Server发起签名请求，CA Server会针对请求进行应答。</p>
<p>SDS Server和CA Server之间进行通信时的接口名为<code>IstioCertificateServiceServer</code>，它只包含了一个函数<code>CreateCertificate()</code>，一方面SDS Server会通过gRPC调用这个函数，另一方面在CA Server中有一个名为<code>pkg.server.ca.Server</code>的对象会实现<code>IstioCertificateServiceServer</code>这个Interface中的<code>CreateCertificate()</code>函数以便对请求进行应答。</p>
<p>除了实现<code>IstioCertificateServiceServer</code>这个Interface之外，<code>pkg.server.ca.Server</code>还实现了另外一个Interface，名为<code>IstioCAServiceServer</code>，其中的函数名为<code>HandleCSR()</code>，这个Interface和函数已经被标记为过时的，我们在后续的文章中将不会对其进行分析，不过为了保持代码完整性，仍然把它包含在对象模型的图中。</p>
<p>现在回头看<code>pkg.server.ca.Server</code></p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Server</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#ce5c00;font-weight:bold">...</span>
	<span style="color:#000">Authenticators</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#000">authenticator</span>
	<span style="color:#000">ca</span>             <span style="color:#000">CertificateAuthority</span>
    <span style="color:#ce5c00;font-weight:bold">...</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>其中有两个核心字段</p>
<ul>
<li>
<p><code>Authenticators</code></p>
<p>第一个是<code>Authenticators</code>，它是<code>authenticator</code>类型的数组，在与SDS Server进行交互时，CA Server通过这个字段来对客户端的身份进行验证。</p>
<p><code>authenticator</code>是一个Interface类型，代码中包含了四种实现</p>
</li>
</ul>
<table>
<thead>
<tr>
<th>认证类型</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>ClientCertAuthenticator</td>
<td>客户端证书认证</td>
</tr>
<tr>
<td>IDTokenAuthenticator</td>
<td>通过OpenID Connect (OIDC) 对客户端请求中的<code>Bearer</code>值进行认证，用于google公有云</td>
</tr>
<tr>
<td>KubeJWTAuthenticator</td>
<td>通过kubeclient向Kubernetes API Server发起验证请求，验证请求中的JWT Token</td>
</tr>
<tr>
<td>jwtAuthenticator</td>
<td>通过OpenID Connect (OIDC) 向Kubernetes API Server验证请求中的JWT Token，主要用于Istiod部署于Kubernetes集群之外的场景</td>
</tr>
</tbody>
</table>
<p><code>authenticator</code>定义如下</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">authenticator</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">Authenticate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">authenticate</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Caller</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
    <span style="color:#000">AuthenticatorType</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">string</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>其中的<code>AuthenticatorType()</code>返回字符串表示的类型，<code>Authenticate()</code>进行真正的验证工作。</p>
<ul>
<li>
<p><code>ca</code></p>
<p><code>ca</code>字段的类型为<code>CertificateAuthority</code></p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#8f5902;font-style:italic">// CertificateAuthority contains methods to be supported by a CA.
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">CertificateAuthority</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">// Sign generates a certificate for a workload or CA, from the given CSR and TTL.
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// TODO(myidpt): simplify this interface and pass a struct with cert field values instead.
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">Sign</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">csrPEM</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">byte</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">subjectIDs</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ttl</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Duration</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">forCA</span> <span style="color:#204a87;font-weight:bold">bool</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">([]</span><span style="color:#204a87;font-weight:bold">byte</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
    <span style="color:#8f5902;font-style:italic">// SignWithCertChain is similar to Sign but returns the leaf cert and the entire cert chain.
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">SignWithCertChain</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">csrPEM</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">byte</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">subjectIDs</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ttl</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Duration</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">forCA</span> <span style="color:#204a87;font-weight:bold">bool</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">([]</span><span style="color:#204a87;font-weight:bold">byte</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
    <span style="color:#8f5902;font-style:italic">// GetCAKeyCertBundle returns the KeyCertBundle used by CA.
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">GetCAKeyCertBundle</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">util</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KeyCertBundle</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>CA Server在处理SDS Server的请求时，就是通过其中的<code>Sign()</code>对客户端的证书签名请求进行签名生成证书，然后再返回给客户端。</p>
<p>这个Interface中的另一个函数<code>SignWithCertChain()</code>用于CA Server的服务器端证书签名，即CA Server对外提供 服务时，客户端需要对CA Server进行身份验证，因此CA Server也需要配置好服务器端证书，这个证书就是使用<code>SignWithCertChain()</code>进行签署的。</p>
<p>这个Interface中的最后一个函数<code>GetCAKeyCertBundle()</code>用来返回根证书、私钥、证书、证书链等等证书实体对象，为了方便CA Server在内部将这些证书对象整合成为一个对象<code>KeyCertBundle</code>，然后通过<code>GetCAKeyCertBundle()</code>将它们一起返回。这个函数和<code>Sign()</code>以及<code>SignWithCertChain()</code>一起使用</p>
</li>
</ul>
<p>一个名为<code>IstioCA</code>结构实现了<code>CertificateAuthority</code>接口，因此在<code>pkg.server.ca.Server</code>结构中的<code>ca</code>字段实际上就是一个<code>IstioCA</code>结构。</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#8f5902;font-style:italic">// IstioCA generates keys and certificates for Istio identities.
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">IstioCA</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#ce5c00;font-weight:bold">...</span>
	<span style="color:#000">keyCertBundle</span> <span style="color:#000">util</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KeyCertBundle</span>
	<span style="color:#000">rootCertRotator</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">SelfSignedCARootCertRotator</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>其中有两个重要成员</p>
<ul>
<li>keyCertBundle，为<code>util.KeyCertBundle</code>类型，把相关证书都绑定到一起，这个整体的对象提供了一些接口</li>
<li>rootCertRotator，为<code>*SelfSignedCARootCertRotator</code>类型，如果是自签名证书的话这个值为空，否则是一个轮询对象，会周期性地更新相关证书</li>
</ul>
<p>另外，在签名关于Pilot Agent代码分析的文章中提到了Pilot Agent中核心对象是<code>pilot.pkg.bootstrap.Server</code>，它内部也有一个<code>ca</code>对象</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Server</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#ce5c00;font-weight:bold">...</span>
	<span style="color:#000">ca</span>               <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ca</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">IstioCA</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>这个ca对象就是<code>IstioCA</code>结构，通过这种方式将CA Server与Pilot Agent主进程联系起来。</p>
<h2 id="二运行过程-">二、运行过程</h2>
<p>TODO</p>

	
	
	<div class="text-muted mt-5 pt-3 border-top">Last modified January 4, 2017
</div>
</div>


          </main>
        </div>
      </div>
      
<footer class="bg-dark py-5 row d-print-none">
  <div class="container-fluid mx-sm-5">
    <div class="row">
      <div class="col-6 col-sm-4 text-xs-center order-sm-2">
        
      </div>
      <div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
        
      </div>
      <div class="col-12 col-sm-4 text-center py-2 order-sm-2">
        <small class="text-white">&copy; 2020 微信: mcsos2048 All Rights Reserved</small>
        
	
      </div>
    </div>
  </div>
</footer>


    </div>
    
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>







<script src="/js/main.min.29b0315468c00226fa6f4556a9cebc0ac4fe1ce1457a01b22c0a06b329877383.js" integrity="sha256-KbAxVGjAAib6b0VWqc68CsT&#43;HOFFegGyLAoGsymHc4M=" crossorigin="anonymous"></script>



  </body>
</html>